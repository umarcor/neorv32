name: Windows

on:
  schedule:
    - cron: '0 0 * * 5'
  workflow_dispatch:

jobs:


  Matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}

    steps:

    - name: 'ğŸ§° Repository Checkout'
      uses: actions/checkout@v2

    - name: 'ğŸ Install doit'
      run: pip install doit

    - name: 'ğŸ”§ Generate examples matrix'
      id: generate
      run: ./do.py GenerateExamplesJobMatrix


  Implementation:
    needs: Matrix
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.Matrix.outputs.matrix) }}
    name: 'ğŸŸ¦ MINGW64 | ${{ matrix.board }} Â· ${{ matrix.design }}'
    defaults:
      run:
        shell: msys2 {0}
    steps:

    - name: 'ğŸŸ¦ Setup MSYS2'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: make
        pacboy: >
          yosys:p
          nextpnr:p
          icestorm:p
          prjtrellis:p
          python-pip:p

    - name: 'âš™ï¸ git config'
      run: git config --global core.autocrlf input
      shell: bash

    - name: 'ğŸ§° Checkout'
      uses: actions/checkout@v2

    - name: 'ğŸ Install doit'
      run: pip install doit

    - name: 'ğŸš§ Generate ${{ matrix.board }} ${{ matrix.design }} bitstream'
      run: ./do.py ex:${{ matrix.board }} -d ${{ matrix.design }} clean bit


  Processor:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include: [
          {icon: 'â¬›', installs: 'MINGW32' },
          {icon: 'ğŸŸ¦', installs: 'MINGW64' },
        ]
    name: '${{ matrix.icon }} ${{ matrix.installs }} | VUnit'
    defaults:
      run:
        shell: msys2 {0}
    steps:

    - name: 'ğŸ§° Checkout'
      uses: actions/checkout@v2

    - name: '${{ matrix.icon }} Setup MSYS2'
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.installs }}
        update: true
        install: make
        pacboy: >
          ghdl:p
          python-pip:p
          riscv64-unknown-elf-gcc:p

    - name: 'ğŸ Install doit and VUnit'
      run: pip install doit vunit_hdl

    - name: 'âš™ï¸ Build and install Processor Check software'
      run: ./do.py BuildAndInstallCheckSoftware
      env:
        RISCV_PREFIX: riscv64-unknown-elf-

    - name: 'ğŸš§ Run Processor Hardware Tests with VUnit'
      run: ./do.py sim:VUnit -a '--ci-mode -v'
